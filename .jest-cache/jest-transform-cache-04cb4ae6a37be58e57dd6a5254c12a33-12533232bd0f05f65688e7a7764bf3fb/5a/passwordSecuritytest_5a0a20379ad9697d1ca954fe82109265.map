{"version":3,"sources":["D:\\Tech Vitta\\Apps\\DEMO\\__tests__\\lib\\passwordSecurity.test.js"],"sourcesContent":["/**\r\n * Password Security Tests\r\n * Tests for password hashing, verification, and rate limiting\r\n */\r\n\r\nimport { \r\n  hashPassword, \r\n  verifyPassword, \r\n  validatePasswordStrength, \r\n  isSecureHash,\r\n  loginRateLimiter \r\n} from '@/lib/passwordSecurity';\r\n\r\n// Crypto is mocked in jest.setup.js, but we need to re-implement it in beforeEach\r\n// because Jest's resetMocks clears the implementations\r\n\r\nconst cryptoHashStore = new Map();\r\n\r\n// Mock localStorage for rate limiter tests\r\nlet rateLimiterStore = {};\r\nconst rateLimiterLocalStorage = {\r\n  getItem: jest.fn((key) => {\r\n    return rateLimiterStore[key] || null;\r\n  }),\r\n  setItem: jest.fn((key, value) => {\r\n    rateLimiterStore[key] = value.toString();\r\n  }),\r\n  removeItem: jest.fn((key) => {\r\n    delete rateLimiterStore[key];\r\n  }),\r\n  clear: jest.fn(() => {\r\n    rateLimiterStore = {};\r\n  })\r\n};\r\n\r\n// Ensure window exists\r\nif (typeof window === 'undefined') {\r\n  global.window = {};\r\n}\r\n\r\nbeforeEach(() => {\r\n  // Reset rate limiter store\r\n  rateLimiterStore = {};\r\n  \r\n  // Re-implement localStorage mocks for rate limiter\r\n  rateLimiterLocalStorage.getItem.mockImplementation((key) => {\r\n    return rateLimiterStore[key] || null;\r\n  });\r\n  rateLimiterLocalStorage.setItem.mockImplementation((key, value) => {\r\n    rateLimiterStore[key] = value.toString();\r\n  });\r\n  rateLimiterLocalStorage.removeItem.mockImplementation((key) => {\r\n    delete rateLimiterStore[key];\r\n  });\r\n  rateLimiterLocalStorage.clear.mockImplementation(() => {\r\n    rateLimiterStore = {};\r\n  });\r\n  \r\n  // Set up localStorage for rate limiter\r\n  Object.defineProperty(window, 'localStorage', {\r\n    value: rateLimiterLocalStorage,\r\n    writable: true,\r\n    configurable: true,\r\n  });\r\n  global.localStorage = rateLimiterLocalStorage;\r\n  \r\n  // Re-implement crypto mocks (Jest's resetMocks might clear them)\r\n  if (global.crypto && global.crypto.subtle) {\r\n    global.crypto.subtle.importKey.mockImplementation(async () => {\r\n      return { format: 'raw', algorithm: { name: 'PBKDF2' }, extractable: false, keyUsages: ['deriveBits'] };\r\n    });\r\n    \r\n    global.crypto.subtle.deriveBits.mockImplementation(async (algorithm, keyMaterial, length) => {\r\n      // Create a consistent hash based on salt\r\n      const saltHex = Array.from(algorithm.salt).map(b => b.toString(16).padStart(2, '0')).join('');\r\n      const key = `${saltHex}-${length}`;\r\n      \r\n      if (!cryptoHashStore.has(key)) {\r\n        // Generate a predictable hash based on salt\r\n        const hash = new Uint8Array(length / 8);\r\n        for (let i = 0; i < hash.length; i++) {\r\n          hash[i] = (i * 7 + saltHex.charCodeAt(i % saltHex.length)) % 256;\r\n        }\r\n        cryptoHashStore.set(key, hash.buffer);\r\n      }\r\n      \r\n      return cryptoHashStore.get(key);\r\n    });\r\n  }\r\n  \r\n  // Clear hash store between tests\r\n  cryptoHashStore.clear();\r\n});\r\n\r\ndescribe('Password Security', () => {\r\n  describe('hashPassword', () => {\r\n    it('should hash a password successfully', async () => {\r\n      const password = 'TestPassword123';\r\n      const hash = await hashPassword(password);\r\n      \r\n      expect(hash).toBeDefined();\r\n      expect(typeof hash).toBe('string');\r\n      expect(hash.includes(':')).toBe(true);\r\n    });\r\n\r\n    it('should throw error for empty password', async () => {\r\n      await expect(hashPassword('')).rejects.toThrow();\r\n    });\r\n\r\n    it('should throw error for non-string password', async () => {\r\n      await expect(hashPassword(null)).rejects.toThrow();\r\n      await expect(hashPassword(123)).rejects.toThrow();\r\n    });\r\n  });\r\n\r\n  describe('verifyPassword', () => {\r\n    it('should verify correct password', async () => {\r\n      const password = 'TestPassword123';\r\n      const hash = await hashPassword(password);\r\n      const isValid = await verifyPassword(password, hash);\r\n      \r\n      expect(isValid).toBe(true);\r\n    });\r\n\r\n    it('should reject incorrect password', async () => {\r\n      const password = 'TestPassword123';\r\n      const hash = await hashPassword(password);\r\n      const isValid = await verifyPassword('WrongPassword', hash);\r\n      \r\n      expect(isValid).toBe(false);\r\n    });\r\n\r\n    it('should handle plain text passwords (backward compatibility)', async () => {\r\n      const password = 'plaintext123';\r\n      const isValid = await verifyPassword(password, password);\r\n      \r\n      expect(isValid).toBe(true);\r\n    });\r\n\r\n    it('should return false for empty inputs', async () => {\r\n      expect(await verifyPassword('', 'hash')).toBe(false);\r\n      expect(await verifyPassword('password', '')).toBe(false);\r\n      expect(await verifyPassword('', '')).toBe(false);\r\n    });\r\n  });\r\n\r\n  describe('validatePasswordStrength', () => {\r\n    it('should accept strong passwords', () => {\r\n      const result = validatePasswordStrength('StrongPass123');\r\n      expect(result.isValid).toBe(true);\r\n    });\r\n\r\n    it('should reject passwords shorter than 8 characters', () => {\r\n      const result = validatePasswordStrength('Short1');\r\n      expect(result.isValid).toBe(false);\r\n      expect(result.message).toContain('8 characters');\r\n    });\r\n\r\n    it('should reject passwords without numbers', () => {\r\n      const result = validatePasswordStrength('NoNumbers');\r\n      expect(result.isValid).toBe(false);\r\n      expect(result.message).toContain('number');\r\n    });\r\n\r\n    it('should reject passwords without letters', () => {\r\n      const result = validatePasswordStrength('12345678');\r\n      expect(result.isValid).toBe(false);\r\n      expect(result.message).toContain('letter');\r\n    });\r\n\r\n    it('should reject passwords longer than 128 characters', () => {\r\n      const longPassword = 'a'.repeat(129) + '1';\r\n      const result = validatePasswordStrength(longPassword);\r\n      expect(result.isValid).toBe(false);\r\n      expect(result.message).toContain('128 characters');\r\n    });\r\n\r\n    it('should reject empty passwords', () => {\r\n      const result = validatePasswordStrength('');\r\n      expect(result.isValid).toBe(false);\r\n      expect(result.message).toContain('required');\r\n    });\r\n  });\r\n\r\n  describe('isSecureHash', () => {\r\n    it('should identify secure hash format', () => {\r\n      expect(isSecureHash('salt:hash')).toBe(true);\r\n      expect(isSecureHash('abc123:def456')).toBe(true);\r\n    });\r\n\r\n    it('should reject plain text as secure hash', () => {\r\n      expect(isSecureHash('plaintext')).toBe(false);\r\n      expect(isSecureHash('password123')).toBe(false);\r\n    });\r\n\r\n    it('should handle invalid formats', () => {\r\n      expect(isSecureHash('')).toBe(false);\r\n      expect(isSecureHash(null)).toBe(false);\r\n      expect(isSecureHash('onlysalt:')).toBe(false);\r\n      expect(isSecureHash(':onlyhash')).toBe(false);\r\n    });\r\n  });\r\n\r\n  describe('LoginRateLimiter', () => {\r\n    beforeEach(() => {\r\n      // Clear rate limiter state\r\n      if (typeof window !== 'undefined') {\r\n        localStorage.removeItem('login_attempts');\r\n      }\r\n      loginRateLimiter.attempts.clear();\r\n    });\r\n\r\n    it('should allow login attempts initially', () => {\r\n      const result = loginRateLimiter.isRateLimited('test@example.com');\r\n      expect(result.isLimited).toBe(false);\r\n      expect(result.attemptsLeft).toBe(5);\r\n    });\r\n\r\n    it('should track failed attempts', () => {\r\n      loginRateLimiter.recordFailedAttempt('test@example.com');\r\n      const result = loginRateLimiter.isRateLimited('test@example.com');\r\n      expect(result.attemptsLeft).toBe(4);\r\n    });\r\n\r\n    it('should lockout after max attempts', () => {\r\n      for (let i = 0; i < 5; i++) {\r\n        loginRateLimiter.recordFailedAttempt('test@example.com');\r\n      }\r\n      const result = loginRateLimiter.isRateLimited('test@example.com');\r\n      expect(result.isLimited).toBe(true);\r\n      expect(result.attemptsLeft).toBe(0);\r\n    });\r\n\r\n    it('should clear attempts on successful login', () => {\r\n      loginRateLimiter.recordFailedAttempt('test@example.com');\r\n      loginRateLimiter.clearAttempts('test@example.com');\r\n      const result = loginRateLimiter.isRateLimited('test@example.com');\r\n      expect(result.isLimited).toBe(false);\r\n      expect(result.attemptsLeft).toBe(5);\r\n    });\r\n\r\n    it('should track attempts per identifier', () => {\r\n      loginRateLimiter.recordFailedAttempt('user1@example.com');\r\n      loginRateLimiter.recordFailedAttempt('user2@example.com');\r\n      \r\n      const result1 = loginRateLimiter.isRateLimited('user1@example.com');\r\n      const result2 = loginRateLimiter.isRateLimited('user2@example.com');\r\n      \r\n      expect(result1.attemptsLeft).toBe(4);\r\n      expect(result2.attemptsLeft).toBe(4);\r\n    });\r\n  });\r\n});\r\n\r\n"],"names":["cryptoHashStore","Map","rateLimiterStore","rateLimiterLocalStorage","getItem","jest","fn","key","setItem","value","toString","removeItem","clear","window","global","beforeEach","mockImplementation","Object","defineProperty","writable","configurable","localStorage","crypto","subtle","importKey","format","algorithm","name","extractable","keyUsages","deriveBits","keyMaterial","length","saltHex","Array","from","salt","map","b","padStart","join","has","hash","Uint8Array","i","charCodeAt","set","buffer","get","describe","it","password","hashPassword","expect","toBeDefined","toBe","includes","rejects","toThrow","isValid","verifyPassword","result","validatePasswordStrength","message","toContain","longPassword","repeat","isSecureHash","loginRateLimiter","attempts","isRateLimited","isLimited","attemptsLeft","recordFailedAttempt","clearAttempts","result1","result2"],"mappings":"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"}